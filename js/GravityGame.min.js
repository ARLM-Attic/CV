/*! GravityGame 05-07-2014 */
var BaseElement=Class.extend({init:function(a,b,c){this.stage=a,void 0!==b&&(this.texture=PIXI.Texture.fromImage(b),this.sprite=new PIXI.Sprite(this.texture)),this.sprite.position.x=c.x,this.sprite.position.y=c.y,this.stage.getStage().addChild(this.sprite),this.moveTimeout=0},getSprite:function(){return this.sprite},changePosition:function(a,b){var c=this.sprite;stepX=(a.x-c.position.x)/(b/33),stepY=(a.y-c.position.y)/(b/33);var d=b/33;this.transitionFunction(c,stepX,stepY,d,a)},transitionFunction:function(a,b,c,d,e){clearTimeout(this.moveTimeout);var f=this;a.position.x+=b,a.position.y+=c,--d>0?this.moveTimeout=setTimeout(function(){f.transitionFunction(a,b,c,d,e)},33):(a.position.x=e.x,a.position.y=e.y)},changeScale:function(a,b){var c=this.sprite;stepScaleX=(a.x-c.scale.x)/(b/33),stepScaleY=(a.y-c.scale.y)/(b/33);var d=b/33,e=function(){c.scale.x+=stepScaleX,c.scale.y+=stepScaleY,--d>0&&setTimeout(e,33)};e()}}),MapElement=BaseElement.extend({init:function(a,b,c,d,e,f){this._super(a,b,c),this.map=a,this.solid=!1,void 0!==d&&(this.sprite.scale.x=this.sprite.scale.y=d),void 0!==f&&(this.sprite.height=f),void 0!==e&&(this.sprite.width=e)}}),SolidMapElement=MapElement.extend({init:function(a,b,c,d,e,f){this._super(a,b,c,d,e,f),this.position=c,this.solid=!0,this.registerBase()},registerBase:function(){this.map.registerPlatform(this.position,this.sprite.width)}}),Basecom=SolidMapElement.extend({init:function(a,b){this.width=744,this._super(a,"sprites/basecom.png",b),this.sprite.width=this.width},registerBase:function(){var a=new Position(this.position.x,this.position.y+295);this.map.registerPlatform(a,this.width)}}),Karlsruhe=SolidMapElement.extend({init:function(a,b){this.width=600,this._super(a,"sprites/karlsruhe.png",b),this.sprite.width=this.width},registerBase:function(){var a=new Position(this.position.x,this.position.y+252);this.map.registerPlatform(a,this.width)}}),Map=BaseElement.extend({spritePositions:{left:1,middle:2600,end:2942,height:600},lowerBase:580,textureFile:"sprites/background.png",init:function(a,b){this._super(a,this.textureFile,new Position(0,0)),this.texture.setFrame(new PIXI.Rectangle(0,0,this.spritePositions.left,this.spritePositions.height));var c=this.spritePositions.middle-this.spritePositions.left,d=b-this.spritePositions.left-(this.spritePositions.end-this.spritePositions.middle),e=d/c,f=new PIXI.Rectangle(this.spritePositions.left,0,c,this.spritePositions.height),g=new PIXI.Texture(PIXI.BaseTexture.fromImage(this.textureFile));g.setFrame(f);for(var h=1;e>=h;h++){var i=new PIXI.Sprite(g);i.position.y=0,i.position.x=this.spritePositions.left+(h-1)*c,this.sprite.addChild(i)}this.changePosition(new Position(400,0),1),this.mapObjects={}},getBaseHeight:function(a){var b=this.lowerBase,c=this.mapObjects[Math.floor(a.x)];if(void 0!==c)for(var d=0;d<c.length;d++){var e=c[d];a.y<=e.y&&(b=Math.min(e.y,b))}return b},getStage:function(){return this.sprite},registerPlatform:function(a,b){for(;b>=0;b--)void 0===this.mapObjects[a.x+b]&&(this.mapObjects[a.x+b]=[]),this.mapObjects[a.x+b].push(a)},addItems:function(a){for(var b=0;b<a.length;b++){var c=a[b],d=new Position(c.x,c.y);switch(c.item){case"platform":new Platform(this,d,c.width);break;case"text":new Text(this,d,c.text,c.size,c.color);break;case"school":new School(this,d);break;case"basecom":new Basecom(this,d);break;case"sap":new Sap(this,d);break;case"karlsruhe":new Karlsruhe(this,d)}}}}),Platform=SolidMapElement.extend({init:function(a,b,c){this.width=c,this._super(a,"sprites/platform.png",b),this.sprite.width=c},registerBase:function(){var a=new Position(this.position.x,this.position.y+20);this.map.registerPlatform(a,this.width)}}),Player=BaseElement.extend({speed:10,maxRunMultiplier:3,runMultiplierStep:.3,jumpHeight:100,jumpInterval:200,moveInterval:100,fallSpeedStep:26,fallInterval:100,winkInterval:170,jumpMiddairDuration:150,jumpRunIncreaseFactor:.5,init:function(a,b){this.currentSprite=1,this.tiemout=0,this.invalidationTimeout=0,this.currentRunMultiplier=1,this.fallSpeed=0,this.moving=!1,this.run=!1,this.jumping=!1,this.falling=!1,this.map=b,this._super(a,"sprites/jonas.png",new Position(100,380)),this.texture.setFrame(new PIXI.Rectangle(0,0,500,500)),this.sprite.scale.x=.4,this.sprite.scale.y=.4,this.refreshFootY(),this.attachKeyListener(),this.wink()},attachKeyListener:function(){var a=this,b={};$(window).keydown(function(c){switch(c.keyCode){case 39:case 68:if(c.preventDefault(),b[c.keyCode])return;b[c.keyCode]=!0,a.moveRight(!0);break;case 37:case 65:if(c.preventDefault(),b[c.keyCode])return;b[c.keyCode]=!0,a.moveLeft(!0);break;case 16:case 17:if(c.preventDefault(),b[c.keyCode])return;b[c.keyCode]=!0,a.run=!0;break;case 32:if(c.preventDefault(),b[c.keyCode])return;b[c.keyCode]=!0,a.jump(!0)}}).keyup(function(c){switch(b[c.keyCode]=!1,c.keyCode){case 39:case 68:case 37:case 65:a.stop(),c.preventDefault();break;case 17:case 16:a.run=!1,c.preventDefault();break;case 32:a.stopJump(),c.preventDefault()}})},moveRight:function(a){this.moving||this.move(a,-this.speed,[1,4])},move:function(a,b,c){var d=this;if(a&&(this.moving=!0,this.currentRunMultiplier=1),this.moving){this.jumping||this.falling||this.currentSprite++,(this.currentSprite>c[1]||this.currentSprite<c[0])&&(this.currentSprite=c[0]),this.texture.setFrame(new PIXI.Rectangle(500*this.currentSprite,0,500,500)),this.run?(this.currentRunMultiplier+=this.runMultiplierStep,this.currentRunMultiplier=Math.min(this.currentRunMultiplier,this.maxRunMultiplier)):this.currentRunMultiplier>1&&!this.jumping&&!this.falling?this.currentRunMultiplier-=this.runMultiplierStep:this.currentRunMultiplier<1&&(this.currentRunMultiplier=1);var e=this.map.sprite.position.x+b*this.currentRunMultiplier;console.log(e),e>600||(this.map.changePosition(new Position(e,this.map.sprite.position.y),100),clearTimeout(this.timeout),this.timeout=setTimeout(function(){d.move(!1,b,c)},this.moveInterval),this.invalidatePosition())}},moveLeft:function(a){this.moving||this.move(a,this.speed,[5,8])},stop:function(){var a=this;return this.jumping||this.falling?void setTimeout(function(){a.stop()},50):(this.moving=!1,this.currentRunMultiplier=1,void clearTimeout(this.timeout))},jump:function(a){var b=this;if(!this.falling&&(a&&(this.jumping=!0),this.jumping)){var c=this.jumpHeight*Math.max(this.currentRunMultiplier*this.jumpRunIncreaseFactor,1),d=this.jumpInterval*Math.max(this.currentRunMultiplier*this.jumpRunIncreaseFactor,1);this.changePosition(new Position(this.sprite.position.x,this.sprite.position.y-c),d),setTimeout(function(){b.stopJump()},d+this.jumpMiddairDuration)}},stopJump:function(){this.jumping=!1,this.invalidatePosition()},refreshFootY:function(){this.footY=this.sprite.position.y+this.sprite.height},invalidatePosition:function(){var a=this;if(this.jumping)return void setTimeout(function(){a.invalidatePosition()},50);this.refreshFootY();var b=this.map.getBaseHeight(new Position(200+-1*this.map.sprite.position.x,this.footY))-this.sprite.height;if(this.sprite.position.y<b){var c=(b-this.sprite.position.y)/this.fallSpeedStep*this.fallInterval;this.falling=!0,this.changePosition(new Position(this.sprite.position.x,b),c),clearTimeout(this.invalidationTimeout),this.invalidationTimeout=setTimeout(function(){a.falling=!1},c)}},wink:function(){var a=this,b=this.moveInterval;this.moveInterval=this.winkInterval,this.move(!0,0,[9,11]),setTimeout(function(){a.stop(),a.moveInterval=b},1e3)}}),Sap=SolidMapElement.extend({init:function(a,b){this.width=838,this._super(a,"sprites/sap.png",b),this.sprite.width=this.width},registerBase:function(){var a=new Position(this.position.x,this.position.y+380);this.map.registerPlatform(a,this.width)}}),School=SolidMapElement.extend({init:function(a,b){this.width=744,this._super(a,"sprites/school.png",b),this.sprite.width=this.width},registerBase:function(){var a=new Position(this.position.x,this.position.y+315);this.map.registerPlatform(a,this.width)}}),Text=MapElement.extend({init:function(a,b,c,d,e){void 0===e&&(e="black"),this.sprite=new PIXI.Text(c,{font:d+" CVFont",fill:e}),this._super(a,void 0,b),a.getStage().addChild(this.sprite)}}),Position=Class.extend({init:function(a,b){this.x=a,this.y=b}}),RenderStage=Class.extend({init:function(a,b){this.renderer=new PIXI.autoDetectRenderer(a,b),document.body.appendChild(this.renderer.view),this.stage=new PIXI.Stage},getStage:function(){return this.stage},getRenderer:function(){return this.renderer},render:function(){this.renderer.render(this.stage)}});